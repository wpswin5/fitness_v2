name: Deploy to Azure

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKER_HUB_USERNAME }}/fitness-api
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  CONTAINER_APP_ENVIRONMENT: fitness-env
  CONTAINER_APP_NAME: fitness-api

jobs:
  deploy-db:
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Get Database Server Info
      id: db-info
      run: |
        # Use existing database credentials from secrets
        echo "db_server=${{ secrets.DB_SERVER }}" >> $GITHUB_OUTPUT
        ENVIRONMENT=${{ github.event.inputs.environment || 'dev' }}
        echo "db_name=fitnessdb-${ENVIRONMENT}" >> $GITHUB_OUTPUT
    
    - name: Run Database Migrations
      working-directory: ./database/scripts
      run: |
        # Install dependencies and ODBC drivers
        sudo apt-get update
        sudo apt-get install -y curl gnupg
        
        # Add Microsoft SQL Server repository
        curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
        curl https://packages.microsoft.com/config/ubuntu/20.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
        
        # Install ODBC driver and sqlcmd tools
        sudo apt-get update
        sudo ACCEPT_EULA=Y apt-get install -y msodbcsql17 mssql-tools18
        
        # Add tools to PATH
        export PATH=$PATH:/opt/mssql-tools18/bin
        
        # Run migrations using sqlcmd
        for file in ../migrations/*.sql; do
          echo "Running migration: $file"
          sqlcmd -S ${{ steps.db-info.outputs.db_server }} \
                 -d ${{ steps.db-info.outputs.db_name }} \
                 -U ${{ secrets.DB_ADMIN_USER }} \
                 -P ${{ secrets.DB_ADMIN_PASSWORD }} \
                 -i "$file"
        done

  build-and-push:
    needs: deploy-db
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Build and Push Docker Image
      uses: docker/build-push-action@v5
      with:
        context: ./app
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}
    
    - name: Create Container Apps Environment (if needed)
      run: |
        # Check if environment exists
        ENV_EXISTS=$(az containerapp env list --resource-group $AZURE_RESOURCE_GROUP --query "[?name=='$CONTAINER_APP_ENVIRONMENT'].id" -o tsv)
        
        if [ -z "$ENV_EXISTS" ]; then
          echo "Creating Container Apps environment..."
          az containerapp env create \
            --name $CONTAINER_APP_ENVIRONMENT \
            --resource-group $AZURE_RESOURCE_GROUP \
            --location eastus2
        else
          echo "Container Apps environment already exists"
        fi
    
    - name: Deploy to Azure Container Apps
      run: |
        ENV=${{ github.event.inputs.environment || 'dev' }}
        APP_NAME="${CONTAINER_APP_NAME}-${ENV}"
        
        az containerapp create \
          --name $APP_NAME \
          --resource-group $AZURE_RESOURCE_GROUP \
          --environment $CONTAINER_APP_ENVIRONMENT \
          --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          --target-port 8000 \
          --ingress external \
          --min-replicas 1 \
          --max-replicas 3 \
          --cpu 0.5 \
          --memory 1.0Gi \
          --env-vars \
            DB_SERVER=${{ secrets.DB_SERVER }} \
            DB_NAME=fitnessdb-${ENV} \
            DB_USER=${{ secrets.DB_ADMIN_USER }} \
            DB_PASSWORD=${{ secrets.DB_ADMIN_PASSWORD }} \
            AZURE_SUBSCRIPTION_ID=${{ secrets.AZURE_SUBSCRIPTION_ID }} \
          --query properties.configuration.ingress.fqdn -o tsv 2>/dev/null || \
        az containerapp update \
          --name $APP_NAME \
          --resource-group $AZURE_RESOURCE_GROUP \
          --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          --query properties.configuration.ingress.fqdn -o tsv
    
    - name: Deployment Summary
      if: success()
      run: |
        ENV=${{ github.event.inputs.environment || 'dev' }}
        APP_NAME="${CONTAINER_APP_NAME}-${ENV}"
        echo "Deployment completed successfully!"
        echo "Container App: $APP_NAME"
        echo "Image: $REGISTRY/$IMAGE_NAME:${{ github.sha }}"
        FQDN=$(az containerapp show --name $APP_NAME --resource-group $AZURE_RESOURCE_GROUP --query properties.configuration.ingress.fqdn -o tsv)
        echo "URL: https://$FQDN"
