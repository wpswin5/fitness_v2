name: Deploy to Azure

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

env:
  REGISTRY: ${{ secrets.AZURE_REGISTRY_LOGIN_SERVER }}
  IMAGE_NAME: fitness-api
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}

jobs:
  deploy-db:
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Get Database Server Info
      id: db-info
      run: |
        # Use existing database credentials from secrets
        echo "db_server=${{ secrets.DB_SERVER }}" >> $GITHUB_OUTPUT
        ENVIRONMENT=${{ github.event.inputs.environment || 'dev' }}
        echo "db_name=fitnessdb-${ENVIRONMENT}" >> $GITHUB_OUTPUT
    
    - name: Run Database Migrations
      working-directory: ./database/scripts
      run: |
        # Install dependencies and ODBC drivers
        sudo apt-get update
        sudo apt-get install -y curl gnupg
        
        # Add Microsoft SQL Server repository
        curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
        curl https://packages.microsoft.com/config/ubuntu/20.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
        
        # Install ODBC driver and sqlcmd tools
        sudo apt-get update
        sudo ACCEPT_EULA=Y apt-get install -y msodbcsql17 mssql-tools18
        
        # Add tools to PATH
        export PATH=$PATH:/opt/mssql-tools18/bin
        
        # Run migrations using sqlcmd
        for file in ../migrations/*.sql; do
          echo "Running migration: $file"
          sqlcmd -S ${{ steps.db-info.outputs.db_server }} \
                 -d ${{ steps.db-info.outputs.db_name }} \
                 -U ${{ secrets.DB_ADMIN_USER }} \
                 -P ${{ secrets.DB_ADMIN_PASSWORD }} \
                 -i "$file"
        done

  build-and-push:
    needs: deploy-db
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Build and Push Docker Image
      working-directory: ./app
      run: |
        az acr build \
          --registry ${{ secrets.AZURE_REGISTRY_NAME }} \
          --image $IMAGE_NAME:${{ github.sha }} \
          --image $IMAGE_NAME:latest \
          --file Dockerfile .
    
    - name: Deploy to Azure Container Instances
      run: |
        az container create \
          --resource-group $AZURE_RESOURCE_GROUP \
          --name fitness-api-${{ github.event.inputs.environment || 'dev' }} \
          --image $REGISTRY/$IMAGE_NAME:${{ github.sha }} \
          --registry-login-server $REGISTRY \
          --registry-username ${{ secrets.AZURE_REGISTRY_USERNAME }} \
          --registry-password ${{ secrets.AZURE_REGISTRY_PASSWORD }} \
          --os-type Linux \
          --cpu 1 \
          --memory 1 \
          --port 8000 \
          --protocol TCP \
          --environment-variables \
            DB_SERVER=${{ secrets.DB_SERVER }} \
            DB_NAME=${{ secrets.DB_NAME }} \
            DB_USER=${{ secrets.DB_ADMIN_USER }} \
            DB_PASSWORD=${{ secrets.DB_ADMIN_PASSWORD }} \
            AZURE_SUBSCRIPTION_ID=${{ secrets.AZURE_SUBSCRIPTION_ID }} \
          --restart-policy OnFailure
    
    - name: Deployment Summary
      if: success()
      run: |
        echo "Deployment completed successfully!"
        echo "Container: fitness-api-${{ github.event.inputs.environment || 'dev' }}"
        echo "Image: $REGISTRY/$IMAGE_NAME:${{ github.sha }}"
